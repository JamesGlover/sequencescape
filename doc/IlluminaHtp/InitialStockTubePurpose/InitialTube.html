<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: IlluminaHtp::InitialStockTubePurpose::InitialTube
  
    &mdash; Documentation by YARD 0.9.5
  
</title>

  <link rel="stylesheet" href="../../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "IlluminaHtp::InitialStockTubePurpose::InitialTube";
  relpath = '../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../class_list.html"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../_index.html">Index (I)</a> &raquo;
    <span class='title'>IlluminaHtp</span> &raquo; <span class='title'><span class='object_link'><a href="../InitialStockTubePurpose.html" title="IlluminaHtp::InitialStockTubePurpose (class)">InitialStockTubePurpose</a></span></span>
     &raquo; 
    <span class="title">InitialTube</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <iframe id="search_frame" src="../../class_list.html"></iframe>

      <div id="content"><h1>Module: IlluminaHtp::InitialStockTubePurpose::InitialTube
  
  
  
</h1>
<div class="box_info">
  

  
  
  
  
  

  
  <dl>
    <dt>Included in:</dt>
    <dd><span class='object_link'><a href="../InitialStockTubePurpose.html" title="IlluminaHtp::InitialStockTubePurpose (class)">IlluminaHtp::InitialStockTubePurpose</a></span></dd>
  </dl>
  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>app/models/illumina_htp/initial_stock_tube_purpose.rb</dd>
  </dl>
  
</div>








  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#sibling_tubes-instance_method" title="#sibling_tubes (instance method)">#<strong>sibling_tubes</strong>(tube)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>We find sibling tubes by first finding the outer request type (library
completion) and the transfer request type We find all outer requests of the
same type in the submission, and match these up with the transfer requests
The RIGHT OUTER JOIN ensures we have a null result for any outer requests
which don&#39;t have matching transfer requests We only pick up open
requests, just in case a whole tube has failed / been cancelled.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#transition_to-instance_method" title="#transition_to (instance method)">#<strong>transition_to</strong>(tube, state, user, _ = nil, customer_accepts_responsibility = false)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#valid_transition%3F-instance_method" title="#valid_transition? (instance method)">#<strong>valid_transition?</strong>(outer_request, target_state)  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  



  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="sibling_tubes-instance_method">
  
    #<strong>sibling_tubes</strong>(tube)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>We find sibling tubes by first finding the outer request type (library
completion) and the transfer request type We find all outer requests of the
same type in the submission, and match these up with the transfer requests
The RIGHT OUTER JOIN ensures we have a null result for any outer requests
which don&#39;t have matching transfer requests We only pick up open
requests, just in case a whole tube has failed / been cancelled.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/illumina_htp/initial_stock_tube_purpose.rb', line 29</span>

<span class='kw'>def</span> <span class='id identifier rubyid_sibling_tubes'>sibling_tubes</span><span class='lparen'>(</span><span class='id identifier rubyid_tube'>tube</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='lbracket'>[</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_tube'>tube</span><span class='period'>.</span><span class='id identifier rubyid_submission'>submission</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='id identifier rubyid_submission_id'>submission_id</span>     <span class='op'>=</span> <span class='id identifier rubyid_tube'>tube</span><span class='period'>.</span><span class='id identifier rubyid_submission'>submission</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span>
  <span class='id identifier rubyid_tfr_request_type'>tfr_request_type</span>  <span class='op'>=</span> <span class='id identifier rubyid_tube'>tube</span><span class='period'>.</span><span class='id identifier rubyid_requests_as_target'>requests_as_target</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='period'>.</span><span class='id identifier rubyid_request_type_id'>request_type_id</span>
  <span class='id identifier rubyid_outr_request_type'>outr_request_type</span> <span class='op'>=</span> <span class='id identifier rubyid_tube'>tube</span><span class='period'>.</span><span class='id identifier rubyid_requests_as_target'>requests_as_target</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='period'>.</span><span class='id identifier rubyid_outer_request'>outer_request</span><span class='period'>.</span><span class='id identifier rubyid_request_type_id'>request_type_id</span>

  <span class='id identifier rubyid_siblings'>siblings</span> <span class='op'>=</span> <span class='const'>Asset</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>assets.*, tfr.state AS quick_state</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_uniq'>uniq</span><span class='period'>.</span>
    <span class='id identifier rubyid_joins'>joins</span><span class='lparen'>(</span><span class='lbracket'>[</span>
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>LEFT JOIN requests AS tfr ON tfr.target_asset_id = assets.id</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>RIGHT OUTER JOIN requests AS outr ON outr.asset_id = tfr.asset_id AND outr.asset_id IS NOT NULL</span><span class='tstring_end'>&#39;</span></span>
    <span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span>
    <span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span>
      <span class='label'>outr:</span> <span class='lbrace'>{</span> <span class='label'>submission_id:</span> <span class='id identifier rubyid_submission_id'>submission_id</span><span class='comma'>,</span> <span class='label'>request_type_id:</span> <span class='id identifier rubyid_outr_request_type'>outr_request_type</span><span class='comma'>,</span> <span class='label'>state:</span> <span class='const'>Request</span><span class='op'>::</span><span class='const'>Statemachine</span><span class='op'>::</span><span class='const'>OPENED_STATE</span> <span class='rbrace'>}</span><span class='comma'>,</span>
      <span class='label'>tfr:</span>  <span class='lbrace'>{</span> <span class='label'>request_type_id:</span> <span class='id identifier rubyid_tfr_request_type'>tfr_request_type</span><span class='comma'>,</span> <span class='label'>submission_id:</span> <span class='id identifier rubyid_submission_id'>submission_id</span> <span class='rbrace'>}</span>
    <span class='rparen'>)</span><span class='period'>.</span>
    <span class='id identifier rubyid_includes'>includes</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='symbol'>:uuid_object</span><span class='comma'>,</span> <span class='symbol'>:barcode_prefix</span><span class='rbracket'>]</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_siblings'>siblings</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_s'>s</span><span class='op'>|</span> <span class='id identifier rubyid_s'>s</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>?</span> <span class='symbol'>:no_tube</span> <span class='op'>:</span> <span class='lbrace'>{</span> <span class='label'>name:</span> <span class='id identifier rubyid_s'>s</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>uuid:</span> <span class='id identifier rubyid_s'>s</span><span class='period'>.</span><span class='id identifier rubyid_uuid'>uuid</span><span class='comma'>,</span> <span class='label'>ean13_barcode:</span> <span class='id identifier rubyid_s'>s</span><span class='period'>.</span><span class='id identifier rubyid_ean13_barcode'>ean13_barcode</span><span class='comma'>,</span> <span class='label'>state:</span> <span class='id identifier rubyid_s'>s</span><span class='period'>.</span><span class='id identifier rubyid_quick_state'>quick_state</span> <span class='rbrace'>}</span> <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="transition_to-instance_method">
  
    #<strong>transition_to</strong>(tube, state, user, _ = nil, customer_accepts_responsibility = false)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


13
14
15
16
17
18
19
20
21
22</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/illumina_htp/initial_stock_tube_purpose.rb', line 13</span>

<span class='kw'>def</span> <span class='id identifier rubyid_transition_to'>transition_to</span><span class='lparen'>(</span><span class='id identifier rubyid_tube'>tube</span><span class='comma'>,</span> <span class='id identifier rubyid_state'>state</span><span class='comma'>,</span> <span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_customer_accepts_responsibility'>customer_accepts_responsibility</span> <span class='op'>=</span> <span class='kw'>false</span><span class='rparen'>)</span>
  <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Base</span><span class='period'>.</span><span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_tube'>tube</span><span class='period'>.</span><span class='id identifier rubyid_requests_as_target'>requests_as_target</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='period'>.</span><span class='id identifier rubyid_not'>not</span><span class='lparen'>(</span><span class='label'>state:</span> <span class='id identifier rubyid_terminated_states'>terminated_states</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_request'>request</span><span class='op'>|</span>
      <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_transition_to'>transition_to</span><span class='lparen'>(</span><span class='id identifier rubyid_state'>state</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_new_outer_state'>new_outer_state</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>started</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>passed</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>qc_complete</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_state'>state</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>started</span><span class='tstring_end'>&#39;</span></span> <span class='op'>:</span> <span class='id identifier rubyid_state'>state</span>
      <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_outer_request'>outer_request</span><span class='period'>.</span><span class='id identifier rubyid_customer_accepts_responsibility!'>customer_accepts_responsibility!</span> <span class='kw'>if</span> <span class='id identifier rubyid_customer_accepts_responsibility'>customer_accepts_responsibility</span>
      <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_outer_request'>outer_request</span><span class='period'>.</span><span class='id identifier rubyid_transition_to'>transition_to</span><span class='lparen'>(</span><span class='id identifier rubyid_new_outer_state'>new_outer_state</span><span class='rparen'>)</span>   <span class='kw'>if</span> <span class='id identifier rubyid_valid_transition?'>valid_transition?</span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_outer_request'>outer_request</span><span class='comma'>,</span> <span class='id identifier rubyid_new_outer_state'>new_outer_state</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="valid_transition?-instance_method">
  
    #<strong>valid_transition?</strong>(outer_request, target_state)  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


9
10
11</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/illumina_htp/initial_stock_tube_purpose.rb', line 9</span>

<span class='kw'>def</span> <span class='id identifier rubyid_valid_transition?'>valid_transition?</span><span class='lparen'>(</span><span class='id identifier rubyid_outer_request'>outer_request</span><span class='comma'>,</span> <span class='id identifier rubyid_target_state'>target_state</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_target_state'>target_state</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>started</span><span class='tstring_end'>&#39;</span></span> <span class='op'>||</span> <span class='id identifier rubyid_outer_request'>outer_request</span><span class='period'>.</span><span class='id identifier rubyid_pending?'>pending?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Mon Dec 19 11:16:35 2016 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.5 (ruby-2.3.3).
</div>

    </div>
  </body>
</html>