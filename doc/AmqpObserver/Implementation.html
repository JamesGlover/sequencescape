<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: AmqpObserver::Implementation
  
    &mdash; Documentation by YARD 0.9.5
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "AmqpObserver::Implementation";
  relpath = '../';
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../class_list.html"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../_index.html">Index (I)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../AmqpObserver.html" title="AmqpObserver (class)">AmqpObserver</a></span></span>
     &raquo; 
    <span class="title">Implementation</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <iframe id="search_frame" src="../class_list.html"></iframe>

      <div id="content"><h1>Module: AmqpObserver::Implementation
  
  
  
</h1>
<div class="box_info">
  

  
  
  
  
  

  
  <dl>
    <dt>Included in:</dt>
    <dd><span class='object_link'><a href="../AmqpObserver.html" title="AmqpObserver (class)">AmqpObserver</a></span></dd>
  </dl>
  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>app/observers/amqp_observer.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>To prevent ActiveRecord::Observer doing something unwanted when we test
this, we pull out the implementation in a module (which can be tested) and
leave the rest behind.</p>


  </div>
</div>
<div class="tags">
  

</div><h2>Defined Under Namespace</h2>
<p class="children">
  
    
  
    
      <strong class="classes">Classes:</strong> <span class='object_link'><a href="Implementation/MostRecentBuffer.html" title="AmqpObserver::Implementation::MostRecentBuffer (class)">MostRecentBuffer</a></span>, <span class='object_link'><a href="Implementation/Proxy.html" title="AmqpObserver::Implementation::Proxy (class)">Proxy</a></span>
    
  
</p>







  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#%3C%3C-instance_method" title="#&lt;&lt; (instance method)">#<strong>&lt;&lt;</strong>(record)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#activate_exchange-instance_method" title="#activate_exchange (instance method)">#<strong>activate_exchange</strong>(&amp;block)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>We may have either Bunny of MArchHare depending on Ruby version.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#determine_record_to_broadcast-instance_method" title="#determine_record_to_broadcast (instance method)">#<strong>determine_record_to_broadcast</strong>(record, &amp;block)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Converts metadata entries to their owner records, if necessary.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#publish_to-instance_method" title="#publish_to (instance method)">#<strong>publish_to</strong>(exchange, record)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#transaction-instance_method" title="#transaction (instance method)">#<strong>transaction</strong>(&amp;block)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>A transaction is (potentially) a bulk send of messages and hence we can
create a buffer that will be written to during changes.</p>
</div></span>
  
</li>

      
    </ul>
  



  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="<<-instance_method">
  
    #<strong>&lt;&lt;</strong>(record)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


109
110
111
112</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/observers/amqp_observer.rb', line 109</span>

<span class='kw'>def</span> <span class='op'>&lt;&lt;</span><span class='lparen'>(</span><span class='id identifier rubyid_record'>record</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_record'>record</span>
  <span class='kw'>self</span> <span class='comment'># Ensure we can chain these if necessary!
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="activate_exchange-instance_method">
  
    #<strong>activate_exchange</strong>(&amp;block)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>We may have either Bunny of MArchHare depending on Ruby version.
Unfortunately their interfaces are slightly different</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


212
213
214</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/observers/amqp_observer.rb', line 212</span>

<span class='kw'>def</span> <span class='id identifier rubyid_activate_exchange'>activate_exchange</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_exchange_interface'>exchange_interface</span><span class='period'>.</span><span class='id identifier rubyid_exchange'>exchange</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="determine_record_to_broadcast-instance_method">
  
    #<strong>determine_record_to_broadcast</strong>(record, &amp;block)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Converts metadata entries to their owner records, if necessary</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


115
116
117
118
119
120
121
122
123
124
125
126</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/observers/amqp_observer.rb', line 115</span>

<span class='kw'>def</span> <span class='id identifier rubyid_determine_record_to_broadcast'>determine_record_to_broadcast</span><span class='lparen'>(</span><span class='id identifier rubyid_record'>record</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='kw'>case</span>
  <span class='kw'>when</span> <span class='id identifier rubyid_record'>record</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='kw'>then</span> <span class='kw'>nil</span> <span class='comment'># Do nothing if we have no record.
</span>    <span class='comment'># This occurs with roles with no authorizable, but may also happen in cases where we have
</span>    <span class='comment'># orphaned records.
</span>  <span class='kw'>when</span> <span class='id identifier rubyid_record'>record</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>WellAttribute</span><span class='rparen'>)</span>  <span class='kw'>then</span> <span class='kw'>yield</span><span class='lparen'>(</span><span class='id identifier rubyid_record'>record</span><span class='period'>.</span><span class='id identifier rubyid_well'>well</span><span class='comma'>,</span>  <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='kw'>when</span> <span class='id identifier rubyid_record'>record</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Metadata</span><span class='op'>::</span><span class='const'>Base</span><span class='rparen'>)</span> <span class='kw'>then</span> <span class='kw'>yield</span><span class='lparen'>(</span><span class='id identifier rubyid_record'>record</span><span class='period'>.</span><span class='id identifier rubyid_owner'>owner</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='kw'>when</span> <span class='id identifier rubyid_record'>record</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Role</span><span class='rparen'>)</span>           <span class='kw'>then</span> <span class='id identifier rubyid_determine_record_to_broadcast'>determine_record_to_broadcast</span><span class='lparen'>(</span><span class='id identifier rubyid_record'>record</span><span class='period'>.</span><span class='id identifier rubyid_authorizable'>authorizable</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='kw'>when</span> <span class='id identifier rubyid_record'>record</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Role</span><span class='op'>::</span><span class='const'>UserRole</span><span class='rparen'>)</span> <span class='kw'>then</span> <span class='id identifier rubyid_determine_record_to_broadcast'>determine_record_to_broadcast</span><span class='lparen'>(</span><span class='id identifier rubyid_record'>record</span><span class='period'>.</span><span class='id identifier rubyid_role'>role</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='kw'>else</span>                                   <span class='kw'>yield</span><span class='lparen'>(</span><span class='id identifier rubyid_record'>record</span><span class='comma'>,</span> <span class='id identifier rubyid_record'>record</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="publish_to-instance_method">
  
    #<strong>publish_to</strong>(exchange, record)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


195
196
197
198
199
200
201</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/observers/amqp_observer.rb', line 195</span>

<span class='kw'>def</span> <span class='id identifier rubyid_publish_to'>publish_to</span><span class='lparen'>(</span><span class='id identifier rubyid_exchange'>exchange</span><span class='comma'>,</span> <span class='id identifier rubyid_record'>record</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_exchange'>exchange</span><span class='period'>.</span><span class='id identifier rubyid_publish'>publish</span><span class='lparen'>(</span>
    <span class='const'>MultiJson</span><span class='period'>.</span><span class='id identifier rubyid_dump'>dump</span><span class='lparen'>(</span><span class='id identifier rubyid_record'>record</span><span class='rparen'>)</span><span class='comma'>,</span>
    <span class='label'>routing_key:</span> <span class='id identifier rubyid_record'>record</span><span class='period'>.</span><span class='id identifier rubyid_routing_key'>routing_key</span> <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_env'>env</span><span class='embexpr_end'>}</span><span class='tstring_content'>.saved.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_record'>record</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_underscore'>underscore</span><span class='embexpr_end'>}</span><span class='tstring_content'>.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_record'>record</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='label'>persistent:</span> <span class='id identifier rubyid_configatron'>configatron</span><span class='period'>.</span><span class='id identifier rubyid_amqp'>amqp</span><span class='period'>.</span><span class='id identifier rubyid_persistent'>persistent</span>
  <span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="transaction-instance_method">
  
    #<strong>transaction</strong>(&amp;block)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>A transaction is (potentially) a bulk send of messages and hence we can
create a buffer that will be written to during changes.  But transactions
can be nested, which means that only the very outer one should do any
publishing.</p>

<p>– What follows looks complicated but is specialised to deal with a
&#39;return&#39; being called from within the block.  In that case the
&#39;return&#39; causes the method to return and <strong>not</strong> to
execute any code after &#39;yield&#39; in the code below.  Therefore you
have the situation where the database transaction has been committed but
the AMQP broadcast has not happened.  But the &#39;ensure&#39; block is
always called, so we assume the transaction to be good (i.e. commit) unless
an exception is raised (when it is marked as bad), and broadcast our buffer
iff the transaction is good and there&#39;s stuff to broadcast. ++</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/observers/amqp_observer.rb', line 81</span>

<span class='kw'>def</span> <span class='id identifier rubyid_transaction'>transaction</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='comment'># JG: This code took me a while to get my head around.
</span>  <span class='comment'># If thread buffer is unset (Ie. we are in the outermost transaction) then
</span>  <span class='comment'># create a new MostRecentBuffer and also set current buffer equal to this
</span>  <span class='comment'># If thread buffer is set (Ie. we are in a nested transaction) do nothing,
</span>  <span class='comment'># current_buffer will be nil
</span>  <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_current'>current</span><span class='lbracket'>[</span><span class='symbol'>:buffer</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='lparen'>(</span><span class='id identifier rubyid_current_buffer'>current_buffer</span> <span class='op'>=</span> <span class='const'>MostRecentBuffer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='kw'>self</span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_transaction_good'>transaction_good</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='kw'>yield</span>
<span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_exception'>exception</span>
  <span class='comment'># Something has gone wrong. We&#39;ll be rolling back to record this so we don&#39;t broadcast
</span>  <span class='comment'># then reraise the error
</span>  <span class='id identifier rubyid_transaction_good'>transaction_good</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_raise'>raise</span>
<span class='kw'>ensure</span>
  <span class='comment'># Everything is complete, grab an exchange and broadcast but only if
</span>  <span class='comment'># 1) The transaction is still flagged as good
</span>  <span class='comment'># 2) current buffer is not blank (ie. we have something to broadcast, and aren&#39;t in an inner transaction)
</span>  <span class='id identifier rubyid_activate_exchange'>activate_exchange</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_exchange'>exchange</span><span class='op'>|</span>
    <span class='id identifier rubyid_current_buffer'>current_buffer</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_record'>record</span><span class='op'>|</span>
      <span class='id identifier rubyid_publish_to'>publish_to</span><span class='lparen'>(</span><span class='id identifier rubyid_exchange'>exchange</span><span class='comma'>,</span> <span class='id identifier rubyid_record'>record</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span> <span class='kw'>if</span> <span class='id identifier rubyid_transaction_good'>transaction_good</span> <span class='kw'>and</span> <span class='kw'>not</span> <span class='id identifier rubyid_current_buffer'>current_buffer</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
  <span class='comment'># The transaction is over, if current buffer isn&#39;t nil (ie. we&#39;re in the outermost transaction)
</span>  <span class='comment'># clean up after yourself and set the thread buffer to nil.
</span>  <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_current'>current</span><span class='lbracket'>[</span><span class='symbol'>:buffer</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>nil</span> <span class='kw'>unless</span> <span class='id identifier rubyid_current_buffer'>current_buffer</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Mon Dec 19 11:16:26 2016 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.5 (ruby-2.3.3).
</div>

    </div>
  </body>
</html>