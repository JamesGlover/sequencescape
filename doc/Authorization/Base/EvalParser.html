<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: Authorization::Base::EvalParser
  
    &mdash; Documentation by YARD 0.9.5
  
</title>

  <link rel="stylesheet" href="../../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "Authorization::Base::EvalParser";
  relpath = '../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../class_list.html"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../_index.html">Index (E)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../Authorization.html" title="Authorization (module)">Authorization</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Base.html" title="Authorization::Base (module)">Base</a></span></span>
     &raquo; 
    <span class="title">EvalParser</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <iframe id="search_frame" src="../../class_list.html"></iframe>

      <div id="content"><h1>Module: Authorization::Base::EvalParser
  
  
  
</h1>
<div class="box_info">
  

  
  
  
  
  

  
  <dl>
    <dt>Included in:</dt>
    <dd><span class='object_link'><a href="ControllerInstanceMethods.html" title="Authorization::Base::ControllerInstanceMethods (module)">ControllerInstanceMethods</a></span></dd>
  </dl>
  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/rails-authorization-plugin/lib/publishare/parser.rb</dd>
  </dl>
  
</div>








  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#parse_authorization_expression-instance_method" title="#parse_authorization_expression (instance method)">#<strong>parse_authorization_expression</strong>(str)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Parses and evaluates an authorization expression and returns
<code>true</code> or <code>false</code>.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process_role-instance_method" title="#process_role (instance method)">#<strong>process_role</strong>(role_name)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process_role_of_model-instance_method" title="#process_role_of_model (instance method)">#<strong>process_role_of_model</strong>(role_name, model_name)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#replace_role-instance_method" title="#replace_role (instance method)">#<strong>replace_role</strong>(str)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#replace_role_of_model-instance_method" title="#replace_role_of_model (instance method)">#<strong>replace_role_of_model</strong>(str)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#replace_temporarily_role_of_model-instance_method" title="#replace_temporarily_role_of_model (instance method)">#<strong>replace_temporarily_role_of_model</strong>(str)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  



  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="parse_authorization_expression-instance_method">
  
    #<strong>parse_authorization_expression</strong>(str)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Parses and evaluates an authorization expression and returns
<code>true</code> or <code>false</code>.</p>

<p>The authorization expression is defined by the following grammar:</p>

<pre class="code ruby"><code class="ruby">       &lt;expr&gt; ::= (&lt;expr&gt;) | not &lt;expr&gt; | &lt;term&gt; or &lt;expr&gt; | &lt;term&gt; and &lt;expr&gt; | &lt;term&gt;
       &lt;term&gt; ::= &lt;role&gt; | &lt;role&gt; &lt;preposition&gt; &lt;model&gt;
&lt;preposition&gt; ::= of | for | in | on | to | at | by
      &lt;model&gt; ::= /:*\w+/
       &lt;role&gt; ::= /\w+/ | /&#39;.*&#39;/</code></pre>

<p>Instead of doing recursive descent parsing (not so fun when we support
nested parentheses, etc), we let Ruby do the work for us by inserting the
appropriate permission calls and using eval. This would not be a good idea
if you were getting authorization expressions from the outside, so in that
case (e.g. somehow letting users literally type in permission expressions)
you&#39;d be better off using the recursive descent parser in Module
RecursiveDescentParser.</p>

<p>We search for parts of our authorization evaluation that match &lt;role&gt;
or &lt;role&gt; &lt;preposition&gt; &lt;model&gt; and we ignore anything
terminal in our grammar.</p>

<p>1) Replace all &lt;role&gt; &lt;preposition&gt; &lt;model&gt; matches. 2)
Replace all &lt;role&gt; matches that aren&#39;t one of our other terminals
(&#39;not&#39;, &#39;or&#39;, &#39;and&#39;, or preposition) 3) Eval</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


30
31
32
33
34
35
36
37
38
39
40
41
42
43
44</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rails-authorization-plugin/lib/publishare/parser.rb', line 30</span>

<span class='kw'>def</span> <span class='id identifier rubyid_parse_authorization_expression'>parse_authorization_expression</span><span class='lparen'>(</span><span class='id identifier rubyid_str'>str</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_str'>str</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>[^A-Za-z0-9_:&#39;\(\)\s]</span><span class='regexp_end'>/</span></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>AuthorizationExpressionInvalid</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Invalid authorization expression (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_str'>str</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span> <span class='kw'>false</span>
  <span class='kw'>end</span>
  <span class='ivar'>@replacements</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_expr'>expr</span> <span class='op'>=</span> <span class='id identifier rubyid_replace_temporarily_role_of_model'>replace_temporarily_role_of_model</span><span class='lparen'>(</span><span class='id identifier rubyid_str'>str</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_expr'>expr</span> <span class='op'>=</span> <span class='id identifier rubyid_replace_role'>replace_role</span><span class='lparen'>(</span><span class='id identifier rubyid_expr'>expr</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_expr'>expr</span> <span class='op'>=</span> <span class='id identifier rubyid_replace_role_of_model'>replace_role_of_model</span><span class='lparen'>(</span><span class='id identifier rubyid_expr'>expr</span><span class='rparen'>)</span>
  <span class='kw'>begin</span>
    <span class='id identifier rubyid_instance_eval'>instance_eval</span><span class='lparen'>(</span><span class='id identifier rubyid_expr'>expr</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>AuthorizationExpressionInvalid</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Cannot parse authorization (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_str'>str</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process_role-instance_method">
  
    #<strong>process_role</strong>(role_name)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../UserDoesntImplementRoles.html" title="Authorization::UserDoesntImplementRoles (class)">UserDoesntImplementRoles</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


80
81
82
83
84</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rails-authorization-plugin/lib/publishare/parser.rb', line 80</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process_role'>process_role</span><span class='lparen'>(</span><span class='id identifier rubyid_role_name'>role_name</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='kw'>false</span> <span class='kw'>if</span> <span class='ivar'>@current_user</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='ivar'>@current_user</span> <span class='op'>==</span> <span class='symbol'>:false</span>
  <span class='id identifier rubyid_raise'>raise</span><span class='lparen'>(</span><span class='const'>UserDoesntImplementRoles</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>User doesn&#39;t implement #has_role?</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='kw'>not</span> <span class='ivar'>@current_user</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span> <span class='symbol'>:has_role?</span>
  <span class='ivar'>@current_user</span><span class='period'>.</span><span class='id identifier rubyid_has_role?'>has_role?</span><span class='lparen'>(</span><span class='id identifier rubyid_role_name'>role_name</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process_role_of_model-instance_method">
  
    #<strong>process_role_of_model</strong>(role_name, model_name)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../ModelDoesntImplementRoles.html" title="Authorization::ModelDoesntImplementRoles (class)">ModelDoesntImplementRoles</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


74
75
76
77
78</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rails-authorization-plugin/lib/publishare/parser.rb', line 74</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process_role_of_model'>process_role_of_model</span><span class='lparen'>(</span><span class='id identifier rubyid_role_name'>role_name</span><span class='comma'>,</span> <span class='id identifier rubyid_model_name'>model_name</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_model'>model</span> <span class='op'>=</span> <span class='id identifier rubyid_get_model'>get_model</span><span class='lparen'>(</span><span class='id identifier rubyid_model_name'>model_name</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span><span class='lparen'>(</span><span class='const'>ModelDoesntImplementRoles</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Model (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_model_name'>model_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>) doesn&#39;t implement #accepts_role?</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='kw'>not</span> <span class='id identifier rubyid_model'>model</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span> <span class='symbol'>:accepts_role?</span>
  <span class='id identifier rubyid_model'>model</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span><span class='symbol'>:accepts_role?</span><span class='comma'>,</span> <span class='id identifier rubyid_role_name'>role_name</span><span class='comma'>,</span> <span class='ivar'>@current_user</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="replace_role-instance_method">
  
    #<strong>replace_role</strong>(str)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


56
57
58
59
60
61
62
63
64
65
66</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rails-authorization-plugin/lib/publishare/parser.rb', line 56</span>

<span class='kw'>def</span> <span class='id identifier rubyid_replace_role'>replace_role</span><span class='lparen'>(</span><span class='id identifier rubyid_str'>str</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_role_regex'>role_regex</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>\s*(\&#39;\s*(.+?)\s*\&#39;|([A-Za-z]\w*))\s*</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_parse_regex'>parse_regex</span> <span class='op'>=</span> <span class='const'>Regexp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_role_regex'>role_regex</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='id identifier rubyid_parse_regex'>parse_regex</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_match'>match</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='const'>BOOLEAN_OPS</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='backref'>$3</span><span class='rparen'>)</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_match'>match</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>else</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> process_role(&#39;</span><span class='embexpr_beg'>#{</span><span class='backref'>$2</span> <span class='op'>||</span> <span class='backref'>$3</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;) </span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="replace_role_of_model-instance_method">
  
    #<strong>replace_role_of_model</strong>(str)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


68
69
70
71
72</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rails-authorization-plugin/lib/publishare/parser.rb', line 68</span>

<span class='kw'>def</span> <span class='id identifier rubyid_replace_role_of_model'>replace_role_of_model</span><span class='lparen'>(</span><span class='id identifier rubyid_str'>str</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>&lt;(\d+)&gt;</span><span class='regexp_end'>/</span></span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_match'>match</span><span class='op'>|</span>
    <span class='ivar'>@replacements</span><span class='lbracket'>[</span><span class='backref'>$1</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="replace_temporarily_role_of_model-instance_method">
  
    #<strong>replace_temporarily_role_of_model</strong>(str)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


46
47
48
49
50
51
52
53
54</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rails-authorization-plugin/lib/publishare/parser.rb', line 46</span>

<span class='kw'>def</span> <span class='id identifier rubyid_replace_temporarily_role_of_model'>replace_temporarily_role_of_model</span><span class='lparen'>(</span><span class='id identifier rubyid_str'>str</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_role_regex'>role_regex</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>\s*(\&#39;\s*(.+?)\s*\&#39;|(\w+))\s+</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_model_regex'>model_regex</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>\s+(:*\w+)</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_parse_regex'>parse_regex</span> <span class='op'>=</span> <span class='const'>Regexp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_role_regex'>role_regex</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>(</span><span class='tstring_end'>&#39;</span></span> <span class='op'>+</span> <span class='const'>VALID_PREPOSITIONS</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>|</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>)</span><span class='tstring_end'>&#39;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_model_regex'>model_regex</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='id identifier rubyid_parse_regex'>parse_regex</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_match'>match</span><span class='op'>|</span>
    <span class='ivar'>@replacements</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> process_role_of_model(&#39;</span><span class='embexpr_beg'>#{</span><span class='backref'>$2</span> <span class='op'>||</span> <span class='backref'>$3</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;, &#39;</span><span class='embexpr_beg'>#{</span><span class='backref'>$5</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;) </span><span class='tstring_end'>&quot;</span></span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> &lt;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@replacements</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>-</span> <span class='int'>1</span><span class='embexpr_end'>}</span><span class='tstring_content'>&gt; </span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Mon Dec 19 11:16:34 2016 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.5 (ruby-2.3.3).
</div>

    </div>
  </body>
</html>